import{jsx as i,jsxs as N,Fragment as E}from"@dropins/tools/preact-jsx-runtime.js";import{Card as M,Header as L,Button as _,InLineAlert as $}from"@dropins/tools/components.js";import"../chunks/OrderCancelReasonsForm.js";import{f as x}from"../chunks/returnOrdersHelper.js";import{classes as R,Slot as U}from"@dropins/tools/lib.js";import{f as w}from"../chunks/formatDateToLocale.js";import{useState as y,useEffect as v}from"@dropins/tools/preact-hooks.js";import{events as I}from"@dropins/tools/event-bus.js";import{useMemo as P,useState as K}from"@dropins/tools/preact-compat.js";import{r as F}from"../chunks/redirectTo.js";import{useText as O}from"@dropins/tools/i18n.js";import"@dropins/tools/preact.js";import{C as G}from"../chunks/OrderLoaders.js";import{G as b}from"../chunks/getGuestOrder.graphql.js";import{f as H,h as V}from"../chunks/fetch-graphql.js";import{t as W}from"../chunks/transform-order-details.js";import{u as j}from"../chunks/useGetStoreConfig.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/convertCase.js";import"../chunks/getStoreConfig.js";const A={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested"},k=({slots:r,title:t,status:s,orderData:e,routeCreateReturn:o})=>{var T;const c=!!(e!=null&&e.returnNumber),n=String(s).toLocaleLowerCase(),d=(T=e==null?void 0:e.returns)==null?void 0:T[0],a=(d==null?void 0:d.returnStatus)??"",m=(d==null?void 0:d.createdReturnAt)??"",p=O(`Order.OrderStatusContent.${A[n]}.title`),C=O(`Order.OrderStatusContent.${A[n]}.message`),f=O(`Order.OrderStatusContent.${A[n]}.messageWithoutDate`),u=O({title:`Order.OrderStatusContent.resturnStatus.${x(a)}`,returnMessage:"Order.OrderStatusContent.returnMessage"});if(!s)return i("div",{});const l=e!=null&&e.orderStatusChangeDate?C==null?void 0:C.message.replace("{DATE}",e==null?void 0:e.orderStatusChangeDate):f.messageWithoutDate,S=(u==null?void 0:u.returnMessage.replace("{ORDER_CREATE_DATE}",w(e==null?void 0:e.orderDate)).replace("{RETURN_CREATE_DATE}",w(m)))??"",g=c?t??u.title:t??p.title;return N(M,{className:"order-order-status-content",variant:"secondary",children:[i(L,{title:g}),N("div",{className:"order-order-status-content__wrapper",children:[i("div",{className:R(["order-order-status-content__wrapper-description",["order-order-status-content__wrapper-description--actions-slot",!!(r!=null&&r.OrderActions)]]),children:i("p",{children:c?S:l})}),i(B,{orderData:e,slots:r,routeCreateReturn:o})]})]})};var h=(r=>(r.CANCEL="CANCEL",r.RETURN="RETURN",r.REORDER="REORDER",r))(h||{});const q=({orderData:r})=>{const[t,s]=y(r),[e,o]=y(r==null?void 0:r.status);return v(()=>{const c=I.on("order/data",n=>{s(n),o(n.status)},{eager:!0});return()=>{c==null||c.off()}},[]),{orderStatus:e,order:t}},B=({className:r,orderData:t,slots:s,routeCreateReturn:e})=>{const o=O({cancel:"Order.OrderStatusContent.actions.cancel",createReturn:"Order.OrderStatusContent.actions.createReturn",createAnotherReturn:"Order.OrderStatusContent.actions.createAnotherReturn",reorder:"Order.OrderStatusContent.actions.reorder"}),c=P(()=>{const n=t==null?void 0:t.availableActions,d=!!(n!=null&&n.length),a=!!(t!=null&&t.returnNumber),m=()=>{F(e,{},t)};return i(E,{children:s!=null&&s.OrderActions?i(U,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:s==null?void 0:s.OrderActions,context:t}):i("div",{"data-testid":"availableActionsList",className:R(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!d]]),children:n==null?void 0:n.map(p=>{switch(p){case h.CANCEL:return i(E,{children:a?null:i(_,{variant:"secondary",children:o.cancel})});case h.RETURN:return i(_,{variant:"secondary",onClick:m,children:a?o.createAnotherReturn:o.createReturn});case h.REORDER:return i(E,{children:a?null:i(_,{variant:"secondary",children:o.reorder})})}})})})},[t,e,s==null?void 0:s.OrderActions,o]);return i("div",{className:R(["order-order-actions",r]),children:c})},Q=`
  mutation CONFIRM_CANCEL_ORDER_MUTATION(
      $orderId: ID!,
      $confirmationKey: String!
    ) {
    confirmCancelOrder(input: {
      order_id: $orderId,
      confirmation_key: $confirmationKey
    }) {
      order {
        ...guestOrderData
      }
      errorV2 {
        message
        code
      }
    }
  }
${b}
`,z=async(r,t)=>H(Q,{variables:{orderId:r,confirmationKey:t}}).then(async({errors:s,data:e})=>{var n,d,a,m;const o=[...(n=e==null?void 0:e.confirmCancelOrder)!=null&&n.errorV2?[(d=e==null?void 0:e.confirmCancelOrder)==null?void 0:d.errorV2]:[],...s??[]];let c=null;return(a=e==null?void 0:e.confirmCancelOrder)!=null&&a.order&&(c=W((m=e==null?void 0:e.confirmCancelOrder)==null?void 0:m.order),I.emit("order/data",c)),o.length>0?V(o):c}),J=({enableOrderCancellation:r})=>{const t=O({orderCancelled:"Order.OrderStatusContent.orderCanceled.message"}),[s,e]=y({text:"",status:void 0});return v(()=>{if(!r)return;const o=new URLSearchParams(window.location.search),c=o.get("orderId"),n=o.get("confirmationKey");c&&n&&z(atob(c),n).then(()=>{e({text:t.orderCancelled,status:"success"})}).catch(d=>{e({text:d.message,status:"warning"})})},[r,t.orderCancelled]),{confirmOrderCancellation:s}},fe=({slots:r,orderData:t,className:s,statusTitle:e,status:o,routeCreateReturn:c})=>{const{orderStatus:n,order:d}=q({orderData:t}),[a,m]=K(!1),p=()=>{m(!0);const l=new URL(window.location.href),S=l.searchParams.get("orderId"),g=l.searchParams.get("confirmationKey");S&&g&&(l.searchParams.delete("orderId"),l.searchParams.delete("confirmationKey"),window.history.replaceState({},document.title,l.toString()))},C=O({cancelOrder:"Order.OrderStatusContent.actions.cancel"}),f=j(),{confirmOrderCancellation:u}=J({enableOrderCancellation:f==null?void 0:f.orderCancellationEnabled});return N("div",{className:R(["order-order-status",s]),children:[!a&&(u==null?void 0:u.status)!==void 0&&i($,{heading:C.cancelOrder,onDismiss:p,description:u.text,type:u.status}),d?i(k,{title:e,status:o||n,slots:r,orderData:d,routeCreateReturn:c}):i(G,{withCard:!1})]})};export{fe as OrderStatus,fe as default};
