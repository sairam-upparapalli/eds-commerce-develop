import{jsx as i,jsxs as g,Fragment as v}from"@dropins/tools/preact-jsx-runtime.js";import{Card as A,Header as I,Button as p,InLineAlert as T}from"@dropins/tools/components.js";import"../chunks/OrderCancelReasonsForm.js";import{Slot as x,classes as S}from"@dropins/tools/lib.js";import{useMemo as L,useState as $}from"@dropins/tools/preact-compat.js";import{useText as u}from"@dropins/tools/i18n.js";import{useState as R,useEffect as E}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/preact.js";import{events as y}from"@dropins/tools/event-bus.js";import{C as U}from"../chunks/OrderLoaders.js";import{G as K}from"../chunks/getGuestOrder.graphql.js";import{f as M,h as F}from"../chunks/fetch-graphql.js";import{t as P}from"../chunks/transform-order-details.js";import{u as G}from"../chunks/useGetStoreConfig.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/convertCase.js";import"../chunks/getStoreConfig.js";const h={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested"},H=({slots:r,title:d,status:o,orderData:e})=>{const s=String(o).toLocaleLowerCase(),t=u(`Order.OrderStatusContent.${h[s]}.title`),n=u(`Order.OrderStatusContent.${h[s]}.message`),c=u(`Order.OrderStatusContent.${h[s]}.messageWithoutDate`);if(!o)return i("div",{});const a=e!=null&&e.orderStatusChangeDate?n==null?void 0:n.message.replace("{DATE}",e==null?void 0:e.orderStatusChangeDate):c.messageWithoutDate;return g(A,{className:"order-order-status-content",variant:"secondary",children:[i(I,{title:d??t.title}),g("div",{className:"order-order-status-content__wrapper",children:[i("div",{className:"order-order-status-content__wrapper-description",children:i("p",{children:a})}),i(V,{orderData:e,slots:r})]})]})};var C=(r=>(r.CANCEL="CANCEL",r.RETURN="RETURN",r.REORDER="REORDER",r))(C||{});const V=({className:r,children:d,orderData:o,slots:e,...s})=>{const t=u({cancel:"Order.OrderStatusContent.actions.cancel",return:"Order.OrderStatusContent.actions.return",reorder:"Order.OrderStatusContent.actions.reorder"}),n=L(()=>{const c=o==null?void 0:o.availableActions,a=!!(c!=null&&c.length);return i(v,{children:e!=null&&e.OrderActions?i(x,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:e==null?void 0:e.OrderActions,context:o}):i("div",{"data-testid":"availableActionsList",className:S(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!a]]),children:c==null?void 0:c.map(m=>{switch(m){case C.CANCEL:return i(p,{variant:"secondary",children:t.cancel});case C.RETURN:return i(p,{variant:"secondary",children:t.return});case C.REORDER:return i(p,{variant:"secondary",children:t.reorder})}})})})},[o,e==null?void 0:e.OrderActions,t]);return i("div",{...s,className:S(["order-order-actions",r]),children:n})},W=({orderData:r})=>{const[d,o]=R(r),[e,s]=R(r==null?void 0:r.status);return E(()=>{const t=y.on("order/data",n=>{o(n),s(n.status)},{eager:!0});return()=>{t==null||t.off()}},[]),{orderStatus:e,order:d}},j=`
  mutation CONFIRM_CANCEL_ORDER_MUTATION(
      $orderId: ID!,
      $confirmationKey: String!
    ) {
    confirmCancelOrder(input: {
      order_id: $orderId,
      confirmation_key: $confirmationKey
    }) {
      order {
        ...guestOrderData
      }
      errorV2 {
        message
        code
      }
    }
  }
${K}
`,q=async(r,d)=>M(j,{variables:{orderId:r,confirmationKey:d}}).then(async({errors:o,data:e})=>{var n,c,a,m;const s=[...(n=e==null?void 0:e.confirmCancelOrder)!=null&&n.errorV2?[(c=e==null?void 0:e.confirmCancelOrder)==null?void 0:c.errorV2]:[],...o??[]];let t=null;return(a=e==null?void 0:e.confirmCancelOrder)!=null&&a.order&&(t=P((m=e==null?void 0:e.confirmCancelOrder)==null?void 0:m.order),y.emit("order/data",t)),s.length>0?F(s):t}),b=({enableOrderCancellation:r})=>{const d=u({orderCancelled:"Order.OrderStatusContent.orderCanceled.message"}),[o,e]=R({text:"",status:void 0});return E(()=>{if(!r)return;const s=new URLSearchParams(window.location.search),t=s.get("orderId"),n=s.get("confirmationKey");t&&n&&q(atob(t),n).then(()=>{e({text:d.orderCancelled,status:"success"})}).catch(c=>{e({text:c.message,status:"warning"})})},[r,d.orderCancelled]),{confirmOrderCancellation:o}},de=({slots:r,orderData:d,className:o,statusTitle:e,status:s})=>{const{orderStatus:t,order:n}=W({orderData:d}),[c,a]=$(!1),m=()=>{a(!0);const O=new URL(window.location.href),_=O.searchParams.get("orderId"),w=O.searchParams.get("confirmationKey");_&&w&&(O.searchParams.delete("orderId"),O.searchParams.delete("confirmationKey"),window.history.replaceState({},document.title,O.toString()))},N=u({cancelOrder:"Order.OrderStatusContent.actions.cancel"}),f=G(),{confirmOrderCancellation:l}=b({enableOrderCancellation:f==null?void 0:f.orderCancellationEnabled});return g("div",{className:S(["order-order-status",o]),children:[!c&&(l==null?void 0:l.status)!==void 0&&i(T,{heading:N.cancelOrder,onDismiss:m,description:l.text,type:l.status}),n?i(H,{title:e,status:s||t,slots:r,orderData:n}):i(U,{withCard:!1})]})};export{de as OrderStatus,de as default};
